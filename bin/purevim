#!/usr/bin/env bash

set -o errexit -o pipefail -o nounset

REPO_URL="https://github.com/carl0xs/purevim.git"
INSTALL_DIR="${HOME}/.config/nvim"

msg() {
  echo "[PureVim] $1"
}

command_exists() {
  command -v "$1" >/dev/null 2>&1
}

install_deps() {
  msg "Installing dependencies..."

  if command_exists apt; then
    sudo apt update
    sudo apt install -y \
      git ninja-build gettext cmake unzip curl build-essential pkg-config \
      ripgrep fzf figlet lua-language-server rust-analyzer nodejs npm
    sudo npm install -g typescript-language-server
  elif command_exists dnf; then
    sudo dnf install -y \
      git ninja-build gettext cmake unzip curl gcc gcc-c++ make pkgconfig \
      ripgrep fzf figlet lua-language-server rust-analyzer nodejs npm
    sudo npm install -g typescript-language-server
  elif command_exists pacman; then
    sudo pacman -Sy --noconfirm \
      git ninja gettext cmake unzip curl base-devel pkgconf \
      ripgrep fzf figlet lua-language-server rust-analyzer nodejs npm
    sudo npm install -g typescript-language-server
  else
    msg "Unsupported package manager. Install dependencies manually."
    exit 1
  fi

  msg "Dependencies installed."
}

install_neovim_from_source() {
  msg "Installing Neovim from source..."

  if [[ -d /tmp/neovim ]]; then
    rm -rf /tmp/neovim
  fi

  git clone https://github.com/neovim/neovim.git /tmp/neovim
  cd /tmp/neovim

  make CMAKE_BUILD_TYPE=RelWithDebInfo
  sudo make install

  msg "Neovim installed."
}

check_figlet_font() {
  if ! figlet -f dos-rebel "PureVim" >/dev/null 2>&1; then
    msg "dos-rebel figlet font missing. Installing locally."

    mkdir -p "${HOME}/.figlet"
    curl -fsSL https://raw.githubusercontent.com/xero/figlet-fonts/master/ANSI%20Shadow.flf \
      -o "${HOME}/.figlet/dos-rebel.flf" || true
  fi
}

install_purevim() {
  msg "Installing PureVim..."

  if [[ -d ${INSTALL_DIR} ]]; then
    mv "${INSTALL_DIR}" "${INSTALL_DIR}.backup"
  fi

  git clone "${REPO_URL}" "${INSTALL_DIR}"

  msg "PureVim installed."
}

main() {
  msg "Starting installation"

  install_deps
  install_neovim_from_source
  check_figlet_font
  install_purevim

  msg "Done"
}

main "$@"

